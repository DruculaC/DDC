C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN Main.OBJ
COMPILER INVOKED BY: D:\Program Files (x86)\keil\C51\BIN\C51.EXE Main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /*---------------------------------------------------
   2                  main.c (v1.00)
   3                  
   4                  DDC-Z program, for electrocar.
   5          ----------------------------------------------------*/
   6          
   7          //µç¶¯³µ
   8          #include "Main.h"
   9          #include "port.h"
  10          
  11          #include "AD.h"
  12          #include "T0.h"
  13          #include "voice.h"
  14          #include "pwm.h"
  15          #include "T1.h"
  16          #include "Delay.h"
  17          #include "communication.h"
  18          #include "Battery.h"
  19          
  20          /*---------------------------------------------------*/
  21          
  22          unsigned char count=0;  //Êý¾Ý½ÓÊÕ²¿·ÖµÄ¼ÆÊýÆ÷
  23          
  24          unsigned int lastAddr=0;//ÉÏÒ»´Î½ÓÊÕµ½µÄ±àÂëµÄµØÖ·
  25          
  26          unsigned char time0Count_1=0;//×÷ÎªÈýÖá´«¸ÐÆ÷Á½¸öÂö³åÖ®¼äµÄÊ±¼ä¼ä¸ô¼ÆÊ±
  27          unsigned char time0Count_2=0;//×÷ÎªÈýÖá´«¸ÐÆ÷µÄ¼ÆÊ±
  28          unsigned char time0Count_6=0;
  29          unsigned int time0Count_3=0;//×÷Îª´®¿ÚÃ¿ÃëÖ÷¸¨»úµÄÐÅÏ¢½»»¥Ê±ÖÓ
  30          unsigned char time0Count_4=0;//×÷ÎªÌ§ÆðÂö³åµÄÊ±¼ä¼ä¸ô¼ÆÊ±
  31          unsigned char time0Count_5=0;//×÷Îªµ¹µØÂö³åµÄÊ±¼ä¼ä¸ô¼ÆÊ±
  32          
  33          bit SensorFlag=0; //ÈýÖá´«¸ÐÆ÷µÄµÍµçÆ½±êÖ¾Î»
  34          unsigned char  SensorCount=0; //×÷ÎªÈýÖá´«¸ÐÆ÷Âö³åµÄ¼ÆÊý
  35          
  36          unsigned char TestFlag=0;//1¡¢2¡¢3·Ö±ðÎªÃ¿´Î½ÓÊÕµ½¸½»ú·¢ËÍÀ´Êý¾ÝºóµÄ¼ÆÊý£¬ÔÚ´®¿ÚµÄ³É¹¦Ö¸ÁîÀï»áÖ´ÐÐ½«È¥¹éÁã
             -µÄ²Ù×÷
  37                          //Èç¹ûÁ¬Ðø3´Î¶¼Ã»ÓÐ¹éÁã£¬ÔòËµÃ÷²»ÔÚ³¡ÁË
  38          unsigned char ModeFlag=1;//Ä£Ê½Ñ¡ÔñÎ»£¬1ÔòÓÃÄ£Ê½1,2ÔòÓÃÄ£Ê½2,3ÔòÎªÄ£Ê½3
  39          
  40          bit alarmFlag=0;//±¨¾¯ÓïÒôµÄ¿ªÆô±êÖ¾
  41          bit alarmFlag2=0;//±¨¾¯ÓïÒô±êÖ¾2
  42          //unsigned int alarmCount=0;//±¨¾¯ÓïÒôµÄ´ÎÊý
  43          
  44          bit threeFlag=0;//ÈýÂ·Ñ­»·¿ª¹Ø±êÖ¾
  45          
  46          bit power1Flag=0;
  47          bit power2Flag=0;
  48          bit power3Flag=0;
  49          bit power4Flag=0;
  50          
  51          bit voiceFlag=0;
  52          bit downUpFlag=0;  //µ¹µØºÍÌ§Æð¼ì²â±êÖ¾
  53          
  54          bit downFlag=0;//µ¹µØµÄ±êÖ¾
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 2   

  55          unsigned char downcount=0;
  56          bit upFlag=0;//Ì§ÆðµÄ±êÖ¾
  57          unsigned char upcount=0;
  58          bit downFlagSend=0;//µ¹µØ·¢ËÍµÄ±êÖ¾
  59          bit upFlagSend=0;//Ì§Æð·¢ËÍµÄ±êÖ¾
  60          
  61          //Ò»¸öÍ·×Ö½Ú£¬Ò»¸öµØÖ·×Ö½Ú£¬Ò»¸öÃüÁî×Ö½Ú£¬Á½¸ö±àÂëµØÖ·×Ö½Ú£¬Á½¸ö±àÂë
  62          unsigned char myTxRxData2[7]={0x00,0x00,0x00,0x00,0x00,0x00,0x00};
  63          //unsigned char Check1=0;//×÷ÎªAD¼ì²âÖµ
  64          
  65          bit receiveFlag=0;//½ÓÊÕµ½Êý¾Ý±êÖ¾
  66          bit commuFlag=0;//¿ªÆôÍ¨ÐÅ±êÖ¾
  67          
  68          unsigned char DataBetween=0;//×÷Îª½ÓÊÕÊý¾ÝµÄÖÐ¼ä±äÁ¿
  69          unsigned char RecData=0;//½ÓÊÕµ½µÄÊý¾Ý
  70          unsigned char DataTime=0;//×÷Îª½ÓÊÕµÄÊý¾ÝµÄÒÆÎ»´ÎÊý¼ÆÊý
  71          bit ComFlag=1;//×öÉÏÉýÑØµÄÒ»¸ö±êÖ¾
  72          //unsigned int newAddr=0;
  73          unsigned char T1highcount=0;       //¶¨Ê±Æ÷T1ÔÚÃ»ÓÐÐÅºÅµ½À´µÄÊ±ºò£¬¶Ô¸ßµçÆ½¼ÆÊý£¬Ò»µ©³¬¹ýÄ³¸öÖµ£¬Ôò½«Datatime
             -Çå0
  74          
  75          
  76          //¶¨Òåµç´ÅÌú×ª¶¯Óë·ñ
  77          unsigned char magnetflag=0;
  78          
  79          
  80          bit ADCcheck=0;                 //ÖÃ1Ê±£¬Ö´ÐÐÒ»´ÎµçÁ¿×ª»»£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  81          bit sendcomm1=0;                //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î·¢ËÍ±àÂë1£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  82          bit sendcomm3=0;                //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î·¢ËÍ±àÂë3£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  83          bit sendcomm4=0;                //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î·¢ËÍ±àÂë4£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  84          bit sendcomm5=0;                //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î·¢ËÍ±àÂë5£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  85          bit magcon=0;                   //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Îµç´ÅÌúËøÉÏ²Ù×÷£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  86          bit magcon2=0;                  //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Îµç´ÅÌú´ò¿ª²Ù×÷£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  87          bit sendspeech1=0;              //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î±¨ÓïÒô£¨±»Åö¾¯¸æ£©£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  88          unsigned char speech1_count=0;
  89          bit sendspeech2=0;              //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î±¨ÓïÒô£¨¾¯µÑÒô+±¨¾¯£©£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  90          bit sendspeech3=0;              //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î±¨ÓïÒô£¨±»Åö¾¯¸æ£©£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  91          unsigned int speech3_count=0;
  92          bit sendspeech4=0;              //ÖÃ1Ê±£¬Ö´ÐÐÒ»´Î±¨ÓïÒô£¨¾¯µÑÒô+±¨¾¯£©£¬Ö´ÐÐÍêºó£¬½«ÆäÖÃ0
  93          bit sendspeech5=0;
  94          bit sendspeech6=0;
  95          bit sendspeech7=0;
  96          unsigned char speech7_count=0;
  97          bit sendspeech8=0;
  98          unsigned char speech8_count=0;
  99          
 100          bit stolenflag=0;               //±»µÁ±êÖ¾Î»
 101          unsigned int stolen_count=0;    //±»µÁ¼ÆÊýµÄÊ±¼ä
 102          unsigned char stolen_flag=0;    //¼ì²â´«¸ÐÆ÷¿ªÊ¼±êÖ¾
 103          
 104          unsigned char turnonflag=0;             //µç¶¯³µ¿ªÆô¹Ø±Õ±êÖ¾Î»£¬1±íÊ¾µç¶¯³µ¿ªÆôÁË£¬0±íÊ¾µç¶¯³µ¹Ø±ÕÁË
 105          unsigned char turnon_speech_flag=0;             //¿ª»úÓïÒô±êÖ¾Î»£¬ÓÃÀ´±ä»»ÓïÒô¡£
 106          
 107          unsigned int Check=0;//µçÁ¿¼ì²â
 108          
 109          void main()
 110          {
 111   1              SensorControl=0;                  //ÉÏµç¹Ø±Õ´«¸ÐÆ÷
 112   1      
 113   1              noVoice();
 114   1              InitT0();
 115   1              InitT1();
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 3   

 116   1              
 117   1              PAshutdown=0;           //½«¹¦·Å¹Ø±Õ
 118   1      
 119   1              upSignal=1;
 120   1              downSignal=1;
 121   1              ET0=1;  //¿ªÆô¶¨Ê±Æ÷0ÖÐ¶Ï
 122   1              ET1=1; //¿ªÆô¶¨Ê±Æ÷1ÖÐ¶Ï
 123   1              PT1=1;//¶¨Ê±Æ÷1µÄÖÐ¶ÏÓÅÏÈ¼¶×î¸ß
 124   1              EA=1;
 125   1              P10=1;
 126   1      //      det_charge=1;
 127   1      
 128   1              BatteryControl=0;       //¸½»úÉÏµçµÄÊ±ºòÖÃ0£¬¼´¿ÉÒÔ³äµç£¬µç³ØÔÚÃ»ÓÐ³äÂúµÄÇé¿öÏÂÎªµÍµçÆ½
 129   1              myPwm();        //¿ª·¢Éä»ú
 130   1      
 131   1              ModeControl_1=0; //·¢Éä»úÄ£Ê½¿ØÖÆ¶Ë,¿ª»úÊ±Îª30MÄ£Ê½
 132   1              
 133   1              magnetflag=0;
 134   1      
 135   1              commuFlag=1; //¿ªÆôÍ¨ÐÅ
 136   1              tran_en=0;   //¹Ø±ÕÎÞÏß·¢Éä»ú
 137   1      
 138   1              downUpFlag=1;
 139   1              det_battery=1;
 140   1      
 141   1              while(1)
 142   1              {
 143   2                      if((det_battery==1)&&(turnonflag==0))              //¿ª³µ×ª¶¯Ô¿³×Ê±£¬Ö´ÐÐÒ»´ÎµçÁ¿×ª»»
 144   2                      {
 145   3                              Delay(30);
 146   3                              if(det_battery==1)
 147   3                              {
 148   4                                      verifybattery(Check);
 149   4                                      PAshutdown=1;
 150   4                                      SC_Speech(7);  
 151   4                                      Delay(160);
 152   4                                      PAshutdown=0;
 153   4                                      
 154   4      /*                              if(turnon_speech_flag==0)
 155   4                                      {
 156   4                                              PAshutdown=1;
 157   4                                              SC_Speech(8);  
 158   4                                              Delay(80);
 159   4                                              PAshutdown=0;
 160   4                                              turnon_speech_flag=1;
 161   4                                      }
 162   4                                      else
 163   4                                      {
 164   4                                              PAshutdown=1;
 165   4                                              SC_Speech(7);  
 166   4                                              Delay(240);
 167   4                                              PAshutdown=0;
 168   4                                              turnon_speech_flag=0;
 169   4                                      }
 170   4      */
 171   4                                      turnonflag=1;
 172   4                              }
 173   3                      }
 174   2                      
 175   2                      if((det_battery==0)&&(turnonflag==1))
 176   2                      {
 177   3                              Delay(30);
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 4   

 178   3                              if(det_battery==0)
 179   3                              {
 180   4                                      verifybattery(Check);
 181   4                                      if((Check<0x300))                                                 //Ð¡ÓÚ38V±¨¾¯£¬Ð¡ÓÚ5¹«ÀïÁË
 182   4                                      {
 183   5                                              PAshutdown=1;
 184   5                                              SC_Speech(10);  //µÍÓÚ3.6vµçÁ¿³ä×ãÌáÊ¾
 185   5                                              Delay(100);
 186   5                                              PAshutdown=0;
 187   5                                      }
 188   4                                      PAshutdown=1;
 189   4                                      SC_Speech(9);
 190   4                                      Delay(130);
 191   4                                      PAshutdown=0;
 192   4                                      turnonflag=0;
 193   4                              }
 194   3                      }
 195   2      
 196   2                      if(ADCcheck==1)
 197   2                      {
 198   3                              Check=GetADCResult(6);  //µç³ØµçÁ¿¼ì²â
 199   3                              ADCcheck=0;     
 200   3                      }
 201   2      
 202   2                      if(magcon==1)
 203   2                      {
 204   3                              if(magnetflag==1)
 205   3                              {
 206   4                                      MagentControl_1=1;//¹Ø±Õ´ÅÌú
 207   4                                      MagentControl_2=0;
 208   4                                      Delay(40);
 209   4                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 210   4                                      MagentControl_2=0;
 211   4                                      magnetflag=0;
 212   4                              }
 213   3                              magcon=0;
 214   3                      }
 215   2      
 216   2                      if(magcon2==1)
 217   2                      {
 218   3                              if(magnetflag==0)
 219   3                              {
 220   4                                      MagentControl_1=0;//¿ªÆô´ÅÌú
 221   4                                      MagentControl_2=1;
 222   4                                      Delay(40);
 223   4                                      MagentControl_1=0;//´ÅÌú³£Ì¬ÎªÕâÖÖÄ£Ê½
 224   4                                      MagentControl_2=0;
 225   4                                      magnetflag=1;
 226   4                              }
 227   3                              magcon2=0;
 228   3                      }
 229   2      /*
 230   2                      if(sendspeech1==1)
 231   2                      {
 232   2                              PAshutdown=1;
 233   2                              SC_Speech(17);  //¹Ø»úÓïÑÔÌáÐÑ
 234   2                              Delay(80);
 235   2                              PAshutdown=0;
 236   2                              sendspeech1=0;
 237   2                      }
 238   2      */
 239   2      /*
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 5   

 240   2                      if(sendspeech2==1)
 241   2                      {
 242   2                              PAshutdown=1;
 243   2                              SC_Speech(18);  //¹Ø»úÓïÑÔÌáÐÑ
 244   2                              Delay(100);
 245   2                              SC_Speech(16);  //¹Ø»úÓïÑÔÌáÐÑ
 246   2                              Delay(100);
 247   2                              PAshutdown=0;
 248   2                              sendspeech2=0;
 249   2                      }
 250   2      */
 251   2                      if((sendspeech3==1)&&(speech3_count<4))
 252   2                      {
 253   3                              if((upSignal==1)&&(downSignal==1))
 254   3                              {
 255   4                                      PAshutdown=1;
 256   4                                      SC_Speech(22);  //¹Ø»úÓïÑÔÌáÐÑ
 257   4                                      ComMode_3_Data();
 258   4                                      Delay(100);
 259   4                                      SC_Speech(23);  //¹Ø»úÓïÑÔÌáÐÑ          
 260   4                                      ComMode_3_Data();
 261   4                                      Delay(60);
 262   4                                      PAshutdown=0;
 263   4                              }
 264   3                              speech3_count++;
 265   3                              if(speech3_count==4)
 266   3                              {
 267   4                                      speech3_count=0;
 268   4                                      sendspeech3=0;
 269   4                                      stolenflag=0;
 270   4                              }
 271   3                      }
 272   2      
 273   2      /*              if(sendspeech3==1)
 274   2                      {
 275   2                              PAshutdown=1;
 276   2                              SC_Speech(18);  //¹Ø»úÓïÑÔÌáÐÑ
 277   2                              Delay(120);
 278   2                              SC_Speech(19);  //¹Ø»úÓïÑÔÌáÐÑ
 279   2                              Delay(140);
 280   2                              SC_Speech(20);  //¹Ø»úÓïÑÔÌáÐÑ
 281   2                              Delay(170);
 282   2                              PAshutdown=0;
 283   2                              sendspeech3=0;
 284   2                      }
 285   2      */
 286   2                      if((sendspeech7==1)&&(speech7_count<1))
 287   2                      {
 288   3                                      sendspeech8=0;
 289   3                                      speech8_count=0;
 290   3                                      
 291   3                                      PAshutdown=1;
 292   3                                      SC_Speech(11);  //¹Ø»úÓïÑÔÌáÐÑ
 293   3                                      Delay(150);
 294   3                                      PAshutdown=0;
 295   3                                      speech7_count++;
 296   3                      }
 297   2      
 298   2                      if((sendspeech8==1)&&(speech8_count<1))
 299   2                      {
 300   3                                      sendspeech7=0;
 301   3                                      speech7_count=0;
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 6   

 302   3                                      
 303   3                                      PAshutdown=1;
 304   3                                      SC_Speech(12);  
 305   3                                      Delay(80);
 306   3                                      SC_Speech(13);
 307   3                                      Delay(80);
 308   3                                      PAshutdown=0;
 309   3                                      speech8_count++;
 310   3                                      SensorControl=1;        //¿ªÆôÈýÖá´«¸ÐÆ÷
 311   3                      }
 312   2              }
 313   1      }
 314          
 315          void timeT1() interrupt 3 //¶¨Ê±Æ÷1ÖÐ¶Ï½ÓÊÕÊý¾Ý
 316          {
 317   1      
 318   1              TH1=timer1H;//ÖØ×°ÔØ
 319   1              TL1=timer1L;
 320   1              
 321   1              if(P11==0)//Õý³£Çé¿öÎª¸ßµçÆ½,ÓÐµÍµçÆ½ËµÃ÷ÓÐÐÅºÅ
 322   1              {
 323   2                      DataBetween++;
 324   2                      ComFlag=0;
 325   2                      if(DataBetween==150)//µÍµçÆ½³ÖÐøµÄ×î´óÊ±¼ä      
 326   2                      {
 327   3                              DataBetween=0;
 328   3                      }
 329   2              }
 330   1              else//Îª¸ßµçÆ½ÁË
 331   1              {
 332   2                      if(ComFlag==0)//ËµÃ÷ÓÐÒ»¸öµÍµçÆ½
 333   2                      {
 334   3                              ComFlag=1;
 335   3      
 336   3                              if((DataBetween>60)&&(DataBetween<=100))        //µÍµçÆ½³ÖÐøµÄÊ±¼äÐ¡ÓÚ10ms£¬ÔòÎª0
 337   3                              {
 338   4                                      RecData<<=1;
 339   4                                      RecData &= 0xfe;
 340   4                                      DataTime++;
 341   4                                      T1highcount=0;
 342   4                              }
 343   3                              else if((DataBetween>100))//µÍµçÆ½³ÖÐøµÄÊ±¼ä´óÓÚ4.5ms£¬ÔòÎª1
 344   3                              {
 345   4                                      RecData<<=1;
 346   4                                      RecData |= 0x01;
 347   4                                      DataTime++;
 348   4                                      T1highcount=0;
 349   4                              }
 350   3                              else
 351   3                              {
 352   4                                      T1highcount++;  
 353   4                              }
 354   3      
 355   3                              DataBetween=0;
 356   3                      }
 357   2      
 358   2                      else
 359   2                      {
 360   3                              T1highcount++;
 361   3                              if(T1highcount>=120)
 362   3                              {
 363   4                                      DataTime=0;
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 7   

 364   4                                      ComFlag=1;
 365   4                                      count=0;
 366   4                              }               
 367   3                      }
 368   2              }
 369   1      
 370   1              if(DataTime==8)//ËµÃ÷Ò»¸ö×Ö½ÚµÄÊý¾ÝÒÑ¾­½ÓÊÜÍêÈ«
 371   1              {
 372   2                      DataTime=0;
 373   2                      myTxRxData2[count]=RecData;
 374   2                      if(count==0&&myTxRxData2[0]==CmdHead)
 375   2                      {
 376   3                              count=1;
 377   3                      }
 378   2                      else if(count==1&&myTxRxData2[1]==MyAddress)
 379   2                      {
 380   3                              count=2;
 381   3                      }
 382   2                      else if(count==2)
 383   2                      {
 384   3                              receiveFlag=1;
 385   3                              count=0;
 386   3                      }
 387   2                      else 
 388   2                      {
 389   3                              count=0;
 390   3                      }
 391   2      /*
 392   2                      else if(count>=2&&count<=5)
 393   2                      {
 394   2                              count++;
 395   2                      }
 396   2                      else if(count==6)
 397   2                      {
 398   2                          receiveFlag=1;
 399   2                              count=0;
 400   2                      }
 401   2                      else 
 402   2                      {
 403   2                              count=0;
 404   2                      }
 405   2      */
 406   2              }
 407   1      
 408   1              if(receiveFlag==1)
 409   1              {
 410   2                      receiveFlag=0;
 411   2                      switch(myTxRxData2[2])          //¶ÔÊý¾ÝÖ¡ÀïµÄÃüÁî½øÐÐ´¦Àí
 412   2                      {
 413   3                              case ComMode_1:                 //¸½»ú·¢ËÍ¹ýÀ´µÄÖ»ÓÃÄ£Ê½1£¬ËµÃ÷ÏÖÔÚÊÇÕý³£µÄ£¬Êý¾Ý²¿·ÖÎªÊý×éµÄµÚÒ»ºÍµÚ¶þ¸ö×Ö½Ú£¬ÎªÃÜÂ
             -ë±íÄÚµÄÕâ¸ö±àÂëµÄ¿ªÊ¼×Ö½ÚµÄÄÇ¸öµØÖ·£¬È»ºóÌî³äÊý¾ÝÖ¡£¬°ÑÃÜÂë±íµÄÊý¾Ý·¢ËÍ³öÈ¥
 414   3                              {
 415   4      //                              sendcomm1=1;
 416   4                                      stolenflag=0;
 417   4                                      
 418   4                                      ComMode_1_Data();       //Ïò¸½»ú·¢ËÍ±àÂë3
 419   4      
 420   4                                      sendspeech7=1;          //±àÂë1ºó±¨Ò»¾äÓïÒô
 421   4      
 422   4      //                              sendspeech8=0;
 423   4      //                              speech8_count=0;
 424   4      
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 8   

 425   4                                      alarmFlag=0;            //¹Ø±¨¾¯±êÖ¾Î»
 426   4      //                              alarmCount=0;           //±¨¾¯¼ÆÊý´ÎÊýÇåÁã
 427   4                                      SensorControl=0;        //ÈýÖá´«¸ÐÆ÷
 428   4                                      downUpFlag=0;           //¹Øµ¹µØ¡¢Ì§Æð¼ì²â
 429   4                                      downFlag=0;
 430   4                                      upFlag=0;
 431   4                                      magcon2=1;                      //´ò¿ªµç´ÅÌú
 432   4                                      
 433   4                                      SensorCount=0;
 434   4                                      time0Count_2=0;
 435   4                                      stolen_count=0;
 436   4                                      stolen_flag=0;
 437   4                                      sendspeech1=0;
 438   4                                      sendspeech2=0;
 439   4                                      sendspeech3=0;
 440   4                                      speech3_count=0;
 441   4      
 442   4                                      TestFlag=0;     
 443   4                                      if(ModeFlag==3||ModeFlag==2)
 444   4                                      {
 445   5                                              ModeFlag=1;
 446   5                                      }
 447   4                              }
 448   3                              break;
 449   3                      }
 450   2              }
 451   1      }
 452          
 453          void time0() interrupt 1        //×÷ÎªÕû¸öÏµÍ³×Ô¼ºµÄÊ±ÖÓ
 454          {
 455   1              TH0=timer0H;//ÖØ×°ÔØ
 456   1              TL0=timer0L;
 457   1              time0Count_3++;
 458   1      
 459   1              if(time0Count_3>=2000)//´®¿ÚÃ¿3s½ÓÊÜÒ»´ÎµÄÊý¾ÝµÄÊ±¼ä±êÖ¾
 460   1              {
 461   2                      if(commuFlag==1)//ËµÃ÷¿ªÆôÁËÍ¨ÐÅ
 462   2                      {
 463   3                              TestFlag++;
 464   3      
 465   3                              if(TestFlag>=4&&ModeFlag==1)//ËµÃ÷Ã»ÓÐ½ÓÊÕµ½Êý¾ÝÒÑ¾­ÓÐ3´ÎÁË£¬¸½»úÒÑ¾­³öÁË3M£¬ÏÖÔÚ¾ÍÒª¼Ó´ó¹¦ÂÊ£¬ÇÐ»»µ½Ä£
             -Ê½2,30MÔÙ¿´ÄÜ²»ÄÜ½ÓÊÕµ½Êý¾Ý
 466   3                              {
 467   4                                      TestFlag=5;
 468   4                                      if(ModeFlag==1)
 469   4                                      {
 470   5                                              magcon=1;                       //µç´ÅÌúËøÉÏ
 471   5                                              sendspeech8=1;          //±¨¸½»úÀë¿ªÓïÒô
 472   5                                              
 473   5      //                                      sendspeech7=0;
 474   5      //                                      speech7_count=0;
 475   5      
 476   5      //                                      SensorControl=1;        //¿ªÆôÈýÖá´«¸ÐÆ÷
 477   5                                              downUpFlag=1;           //¿ªÆôµ¹µØ¡¢Ì§Æð±êÖ¾
 478   5                                              ModeFlag=2;
 479   5      
 480   5                                              SensorCount=0;
 481   5                                              time0Count_2=0;
 482   5                                      }       
 483   4                              }
 484   3                      }
 485   2                      time0Count_3=0;
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 9   

 486   2                      
 487   2      //              ComMode_1_Data();
 488   2      
 489   2                      ADCcheck=1;             
 490   2                      
 491   2                      if((downFlag==1)&&(downcount<5))  //µ¹µØºó×öÏàÓ¦µÄ¶¯×÷
 492   2                      {
 493   3      //                      sendcomm5=1;
 494   3                              ComMode_5_Data(); //Ïò¸½»ú·¢ËÍ±àÂë3
 495   3                              downcount++;
 496   3                      }
 497   2                      if((upFlag==1)&&(upcount<5))            //Ì§Æðºó×öÏàÓ¦¶¯×÷
 498   2                      {
 499   3      //                      sendcomm4=1;
 500   3                              ComMode_4_Data(); //Ïò¸½»ú·¢ËÍ±àÂë3
 501   3                              upcount++;
 502   3                      }
 503   2      
 504   2      /*
 505   2              if((stolenflag==1)&&(speech3_count<4))
 506   2                      {
 507   2                              ComMode_3_Data();       
 508   2                      }
 509   2      */
 510   2              }
 511   1      
 512   1              if(SensorControl==1)    //¼ì²âÈýÖá´«¸ÐÆ÷ÊÇ·ñ´ò¿ª£¬²¢ÇÒ»¹Ã»ÓÐ±¨¾¯
 513   1              {
 514   2                      if((ReceWave==1)&&(stolenflag==0))
 515   2                      {
 516   3                              time0Count_2++;
 517   3                              if(time0Count_2>=8)                              //Ã¿1ms¼ì²âÒ»´Î¸ßµçÆ½£¬Èç¹û´óÓÚÁË6msµÄ¸ß¶¨Æ½£¬ËµÃ÷ÓÐÈËÅöÁËÒ»ÏÂ
 518   3                              {
 519   4                                      time0Count_2=0;
 520   4                                      SensorCount++;
 521   4                                      speech1_count=0;
 522   4                                      stolen_flag=1;
 523   4                              }
 524   3                      }
 525   2                      else
 526   2                      {
 527   3                              time0Count_2=0;
 528   3                      }
 529   2                      
 530   2                      if(stolen_flag==1)
 531   2                      {
 532   3                              stolen_count++;
 533   3                              if(stolen_count>=6000)
 534   3                              {
 535   4                                      SensorCount=0;
 536   4                                      time0Count_2=0;
 537   4                                      stolen_count=0;
 538   4                                      stolen_flag=0;
 539   4                                      sendspeech1=0;
 540   4                                      speech1_count=0;
 541   4                                      sendspeech2=0;
 542   4                              }
 543   3                      }
 544   2              }
 545   1      
 546   1              if(SensorCount==1)
 547   1              {
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 10  

 548   2      //              sendspeech1=1;
 549   2                      if((speech1_count<1)&&(sendspeech3!=1))
 550   2                      {
 551   3                              if((downSignal==1)&&(upSignal==1))
 552   3                              {
 553   4                                      PAshutdown=1;
 554   4                                      SC_Speech2(17);  //¹Ø»úÓïÑÔÌáÐÑ
 555   4                                      Delay(80);
 556   4                                      PAshutdown=0;
 557   4                                      speech1_count++;
 558   4                              }
 559   3                      }
 560   2              }
 561   1              else
 562   1              {
 563   2                      if(stolen_count>=3000)
 564   2                      {
 565   3                              if(ReceWave==1)
 566   3                              {
 567   4                                      time0Count_6++;
 568   4                                      if(time0Count_6>=6)     
 569   4                                      {
 570   5                                              sendspeech3=1;
 571   5                                              speech3_count=0;
 572   5                                              stolenflag=1;
 573   5                                              time0Count_6=0; 
 574   5                                      }
 575   4                              }
 576   3                              else
 577   3                              {
 578   4                                      time0Count_6=0;
 579   4                              }
 580   3                      }                                                
 581   2              }
 582   1      
 583   1      //      ¼ì²âµ¹µØºÍÌ§Æð¼ì²âµÄ´úÂë
 584   1              if(downUpFlag==1)//¿ªÆôÁËÌ§Æðµ¹µØ¼ì²â
 585   1              {
 586   2                      if(upSignal==0)//ËµÃ÷ÓÐÌ§ÆðÐÅºÅ²¢ÇÒÊÇµÚÒ»´Î£¬¿ªÊ¼¼ÆÊ±
 587   2                      {
 588   3                              time0Count_4++;
 589   3                              if(time0Count_4==10)//ËµÃ÷ÒÑ¾­´óÓÚ0.5S
 590   3                              {
 591   4                                      upFlag=1;//ÖÃÌ§Æð±êÖ¾
 592   4                                      downFlag=0;
 593   4                                      alarmFlag=0;
 594   4                              }               
 595   3                      }
 596   2                      else
 597   2                      {
 598   3                              upFlag=0;
 599   3                              upcount=0;
 600   3                              time0Count_4=0;
 601   3                      }
 602   2      
 603   2                      if(downSignal==0)//ËµÃ÷ÓÐÌ§ÆðÐÅºÅ£¬¿ªÊ¼¼ÆÊ±
 604   2                      {
 605   3                              time0Count_5++;
 606   3                              if(time0Count_5==10)//ËµÃ÷ÒÑ¾­´óÓÚ0.5S
 607   3                              {
 608   4                                      downFlag=1;//ÖÃÌ§Æð±êÖ¾
 609   4                                      upFlag=0;
C51 COMPILER V9.51   MAIN                                                                  09/27/2013 11:57:37 PAGE 11  

 610   4                                      alarmFlag=0;
 611   4                              }               
 612   3                      }
 613   2                      else
 614   2                      {
 615   3                              downFlag=0;
 616   3                              downcount=0;
 617   3                              time0Count_5=0;
 618   3                      }
 619   2              }
 620   1      }
 621          
 622          
 623          /*---------------------------------------------------
 624                  end of file
 625          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1039    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     39    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =     33    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
