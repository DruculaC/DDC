C51 COMPILER V9.51   MAIN                                                                  11/04/2013 10:31:59 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN Main.OBJ
COMPILER INVOKED BY: D:\Program Files (x86)\keil\C51\BIN\C51.EXE Main.c BROWSE DEBUG OBJECTEXTEND TABS(3)

line level    source

   1          /*---------------------------------------------------
   2             main.c (v1.00)
   3             
   4             DDC-Z program, for electrocar.
   5          ----------------------------------------------------*/
   6          
   7          //电动车
   8          #include "Main.h"
   9          #include "port.h"
  10          
  11          #include "AD.h"
  12          #include "voice.h"
  13          #include "pwm.h"
  14          #include "Timer.h"
  15          #include "Delay.h"
  16          #include "communication.h"
  17          #include "Battery.h"
  18          #include "Other.h"
  19                                                  
  20          /*------- Public variable declarations --------------------------*/
  21          extern bit stolen_alarm_flag;    //主机被盗报警标志，1的时候表示触发    
  22          extern bit host_stolen_speech_EN;      //主机被盗语音使能，1的时候在main中语音提示
  23          extern bit battery_check;              //置1时，执行一次电量转换，执行完后，将其置0
  24          extern bit position_sensor_EN;         //位置传感器，即倒地抬起传感器总开关，1的时候，检测这两个传感器
  25          extern bit slave_away_speech_EN;       //判断附机离开后，语音提示，在main里面操作
  26          extern bit magnet_CW_EN;               //电磁铁顺时针转动使能，转动一次后复位为0
  27          extern bit comm_whole_control;            //通信总开关，0关闭通信，1打开通信
  28          extern tWord host_stolen_speech_count;    //判断主机被盗后，语音提示的次数
  29          extern bit magnet_ACW_EN;                 //电磁铁逆时针转动使能，转动一次后复位为0
  30          extern bit slave_nearby_speech_EN;       //判断附近靠近后，语音提示，在main里面操作
  31          
  32          /*------- Private variable declarations --------------------------*/
  33          bit magnet_ACW_flag=0;
  34          tByte slave_nearby_speech_count=0;
  35          tByte slave_away_speech_count=0;
  36          bit key_rotated_on_flag=0;       //电动车开启关闭标志位，1表示电动车开启了，0表示电动车关闭了
  37          tWord ADC_check_result = 0;      //作为AD检测值
  38          
  39          void main()
  40          {
  41   1         InitTimer(1,100);
  42   1         
  43   1         sensor_EN=0;
  44   1      
  45   1         noVoice();
  46   1         myPwm(); //开发射机
  47   1      
  48   1         voice_EN=0;    //将功放关闭
  49   1      
  50   1         raised_sensor_detect=1;
  51   1         fell_sensor_detect=1;
  52   1      
  53   1         P10=1;
  54   1      
  55   1         transmiter_power=0; //发射机模式控制端,开机时为30M模式
C51 COMPILER V9.51   MAIN                                                                  11/04/2013 10:31:59 PAGE 2   

  56   1         
  57   1         magnet_ACW_flag=0;
  58   1      
  59   1         comm_whole_control=1; //开启通信
  60   1         transmiter_EN=0;
  61   1      
  62   1         position_sensor_EN=1;
  63   1         key_rotate = 1;
  64   1      
  65   1         while(1)
  66   1         {
  67   2            if((key_rotate==1)&&(key_rotated_on_flag==0))         //开车转动钥匙时，执行一次电量转换
  68   2            {
  69   3               Delay(30);
  70   3               if(key_rotate==1)
  71   3               {
  72   4                  verifybattery(ADC_check_result);
  73   4                  key_rotate_on_speech();
  74   4                  key_rotated_on_flag=1;
  75   4               }
  76   3            }
  77   2            
  78   2            if((key_rotate==0)&&(key_rotated_on_flag==1))
  79   2            {
  80   3               Delay(30);
  81   3               if(key_rotate==0)
  82   3               {
  83   4                  verifybattery(ADC_check_result);
  84   4                  if((ADC_check_result<0x300))                   //小于38V报警，小于5公里了
  85   4                     {
  86   5                     motorBAT_low_speech();
  87   5                     }
  88   4                     
  89   4                  key_rotate_off_speech();
  90   4                  key_rotated_on_flag=0;
  91   4               }
  92   3            }
  93   2      
  94   2            if(battery_check==1)
  95   2            {
  96   3               ADC_check_result=GetADCResult(6);   //电池电量检测
  97   3               battery_check=0;  
  98   3            }
  99   2      
 100   2            if(magnet_CW_EN==1)
 101   2            {
 102   3               if(magnet_ACW_flag==1)
 103   3               {
 104   4                  magnet_CW();
 105   4                  magnet_ACW_flag=0;
 106   4               }
 107   3               magnet_CW_EN=0;
 108   3            }
 109   2      
 110   2            if(magnet_ACW_EN==1)
 111   2            {
 112   3               if(magnet_ACW_flag==0)
 113   3               {
 114   4                  magnet_ACW();
 115   4                  magnet_ACW_flag=1;
 116   4               }
 117   3               magnet_ACW_EN=0;
C51 COMPILER V9.51   MAIN                                                                  11/04/2013 10:31:59 PAGE 3   

 118   3            }
 119   2      
 120   2            if((host_stolen_speech_EN==1)&&(host_stolen_speech_count<4))
 121   2            {
 122   3               if((raised_sensor_detect==1)&&(fell_sensor_detect==1))
 123   3                  {
 124   4                  stolen_alarm_speech();
 125   4                  }
 126   3               host_stolen_speech_count++;
 127   3               if(host_stolen_speech_count==4)
 128   3               {
 129   4                  host_stolen_speech_count=0;
 130   4                  host_stolen_speech_EN=0;
 131   4                  stolen_alarm_flag=0;
 132   4               }
 133   3            }
 134   2      
 135   2            if((slave_nearby_speech_EN==1)&&(slave_nearby_speech_count<1))
 136   2            {
 137   3                  slave_away_speech_EN=0;
 138   3                  slave_away_speech_count=0;
 139   3                  slave_nearby_speech();
 140   3                  slave_nearby_speech_count++;
 141   3            }
 142   2      
 143   2            if((slave_away_speech_EN==1)&&(slave_away_speech_count<1))
 144   2            {
 145   3                  slave_nearby_speech_EN=0;
 146   3                  slave_nearby_speech_count=0;
 147   3                  
 148   3                  slave_away_speech();
 149   3                  
 150   3                  slave_away_speech_count++;
 151   3                  sensor_EN=1;   //开启三轴传感器
 152   3            }
 153   2         }
 154   1      }
 155          
 156          
 157          
 158          /*---------------------------------------------------
 159             end of file
 160          ----------------------------------------------------*/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    239    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
